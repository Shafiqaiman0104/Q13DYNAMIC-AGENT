<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Dashboard - Q13</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #ff6a00;
            --secondary-color: #0b75f9;
            --success-color: #4cc9f0;
            --warning-color: #f72585;
            --info-color: #7209b7;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --gray-color: #6c757d;
            --border-radius: 12px;
            --box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fb;
            color: var(--dark-color);
            min-height: 100vh;
            padding-bottom: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 15px;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo i {
            font-size: 2.2rem;
        }

        .logo h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 2px solid white;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Navigation Tabs */
        .tabs {
            display: flex;
            background-color: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 2rem;
            box-shadow: var(--box-shadow);
        }

        .tab {
            flex: 1;
            padding: 1.2rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            background-color: rgba(67, 97, 238, 0.05);
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            background-color: rgba(67, 97, 238, 0.1);
        }

        .tab i {
            margin-right: 8px;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            background-color: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--box-shadow);
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }

        .stat-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 1.8rem 1.5rem;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            border-left: 5px solid var(--primary-color);
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card.total-orders {
            border-left-color: var(--primary-color);
        }

        .stat-card.total-sales {
            border-left-color: var(--info-color);
        }

        .stat-card.total-commission {
            border-left-color: var(--success-color);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
        }

        .stat-icon.total-orders {
            background-color: var(--primary-color);
        }

        .stat-icon.total-sales {
            background-color: var(--info-color);
        }

        .stat-icon.total-commission {
            background-color: var(--success-color);
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 1rem;
            color: var(--gray-color);
            font-weight: 500;
        }

        /* Data Tables */
        .data-table-container {
            overflow-x: auto;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        .data-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .data-table td {
            padding: 0.8rem;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }

        .data-table tr:hover {
            background-color: rgba(67, 97, 238, 0.05);
        }

        .data-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .status {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
        }

        .status.paid, .status.delivered {
            background-color: rgba(40, 167, 69, 0.15);
            color: #28a745;
        }

        .status.pending {
            background-color: rgba(255, 193, 7, 0.15);
            color: #ffc107;
        }

        .status.cancelled {
            background-color: rgba(220, 53, 69, 0.15);
            color: #dc3545;
        }

        /* Filters and Search */
        .filters {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 0.8rem 1rem 0.8rem 2.5rem;
            border: 1px solid #ddd;
            border-radius: 30px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .search-box i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-color);
        }

        .filter-select {
            padding: 0.8rem 1rem;
            border: 1px solid #ddd;
            border-radius: 30px;
            font-size: 1rem;
            background-color: white;
            min-width: 150px;
        }

        /* Loading Spinner */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(67, 97, 238, 0.2);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Error Message */
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: var(--border-radius);
            border: 1px solid #f5c6cb;
            margin-bottom: 1rem;
            display: none;
        }

        /* Compact view for smaller screens */
        .compact-text {
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Logout button */
        .logout-btn {
            padding: 0.5rem 1rem;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            margin-top: 5px;
        }

        .logout-btn:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        /* Mobile Responsive */
        @media (max-width: 992px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .tab {
                flex: 1 0 calc(50% - 4px);
                padding: 1rem 0.5rem;
            }

            .tab-content {
                padding: 1.5rem 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .stat-card {
                padding: 1.5rem 1rem;
            }

            .filters {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box, .filter-select {
                width: 100%;
            }
        }

        @media (max-width: 576px) {
            .tab {
                flex: 1 0 100%;
            }

            .logo h1 {
                font-size: 1.5rem;
            }

            .stat-value {
                font-size: 1.8rem;
            }
        }

        /* Agent Type Badges */
        .agent-type-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
        }

        .agent-type-badge.basic {
            background-color: rgba(108, 117, 125, 0.15);
            color: #6c757d;
        }

        .agent-type-badge.premium {
            background-color: rgba(255, 193, 7, 0.15);
            color: #ffc107;
        }

        /* Chart Container */
        .chart-container {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--box-shadow);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
        }

/* Date filter responsive */
@media (max-width: 992px) {
    .date-filter-container {
        flex-wrap: wrap;
        gap: 0.5rem !important;
    }
    
    .date-filter-container > div {
        flex: 1;
        min-width: 140px;
    }
}

@media (max-width: 768px) {
    .date-filter-container {
        flex-direction: column;
        align-items: stretch !important;
        gap: 0.5rem !important;
    }
    
    .date-filter-container > div {
        width: 100%;
    }
    
    #clear-date-filter {
        width: 100%;
    }
}
/* Add this to your CSS section, near the other styles */
.upgrade-message {
    background: linear-gradient(135deg, #ffd700, #ff9800);
    color: #000;
    padding: 1rem 1.5rem;
    border-radius: var(--border-radius);
    margin-top: 1rem;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 4px 12px rgba(255, 152, 0, 0.2);
    border-left: 5px solid #ff9800;
}

.upgrade-message i {
    font-size: 1.5rem;
}

.contact-message {
    background: linear-gradient(135deg, #4cc9f0, #4361ee);
    color: white;
    padding: 1rem 1.5rem;
    border-radius: var(--border-radius);
    margin-top: 2rem;
    display: flex;
    align-items: center;
    gap: 10px;
    box-shadow: var(--box-shadow);
    border-left: 5px solid #4361ee;
}
/* Contest video link styling */
.contest-video-link {
    color: var(--primary-color);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 5px 10px;
    border-radius: 4px;
    transition: var(--transition);
}

.contest-video-link:hover {
    background-color: rgba(255, 106, 0, 0.1);
    transform: translateY(-2px);
}
/* Add this to your CSS section */
.status-message {
    padding: 0.5rem;
    border-radius: 8px;
    font-size: 0.85rem;
    margin-top: 0.5rem;
    border-left: 3px solid transparent;
}

.status-message.info {
    background-color: rgba(13, 110, 253, 0.1);
    border-left-color: #0d6efd;
    color: #0a58ca;
}

.status-message.success {
    background-color: rgba(25, 135, 84, 0.1);
    border-left-color: #198754;
    color: #157347;
}

.status-message.warning {
    background-color: rgba(255, 193, 7, 0.1);
    border-left-color: #ffc107;
    color: #997404;
}
/* Add this to your CSS */
.downline-reminder-message {
    background-color: rgba(255, 193, 7, 0.15);
    color: #997404;
    padding: 1rem 1.5rem;
    border-radius: var(--border-radius);
    margin-bottom: 1.5rem;
    border-left: 5px solid #ffc107;
    display: flex;
    align-items: center;
    gap: 10px;
}

.downline-reminder-message i {
    font-size: 1.2rem;
}
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-chart-line"></i>
                    <h1>Q13 Agent Dashboard</h1>
                </div>
                <div class="user-info">
                    <div class="user-avatar">
                        <img src="Q13LOGO.png" alt="Logo">
                    </div>
                    <div>
                        <h3 id="welcomeText">Welcome!</h3>
                        <button class="logout-btn" onclick="logout()">Logout</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Error Message Area -->
        <div class="error-message" id="error-message">
            <strong>Error:</strong> <span id="error-text"></span>
        </div>

        <!-- Navigation Tabs -->
        <div class="tabs">
            <div class="tab" data-tab="contest">
                <i class="fas fa-trophy"></i> Contest
            </div>
            <div class="tab active" data-tab="dashboard">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </div>
            <div class="tab" data-tab="customer-order">
                <i class="fas fa-shopping-cart"></i> Customer Order
            </div>
            <div class="tab" data-tab="top-agent">
                <i class="fas fa-trophy"></i> Top Agent
            </div>
<!-- Add this new tab -->
<div class="tab" data-tab="my-agent">
    <i class="fas fa-users"></i> My Agent
</div>
  <div class="tab" data-tab="commission-rate">
        <i class="fas fa-percentage"></i> Commission Rate
    </div>
            <div class="tab" data-tab="my-profile">
                <i class="fas fa-user"></i> My Profile
            </div>
        </div>

        <!-- Contest Tab -->
        <div id="contest" class="tab-content">
            <div style="text-align: center; margin-bottom: 2rem;">
                <h2 style="color: var(--primary-color); margin-bottom: 0.5rem;">Contest 2026 Q1 (Jan - March)</h2>
                <h3 style="color: var(--secondary-color);">CNY & HARI RAYA</h3>
            </div>
            
            <div class="data-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Video</th>
                            <th>Product Code</th>
                            <th>Product Name</th>
                            <th>Bonus</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><img src="https://klmfirework.com/cdn/shop/files/SV216.png?v=1764129152&width=493" alt="SV216" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;"></td>
                            <td>
                                <a href="https://klmfirework.com/cdn/shop/videos/c/vp/bd37b03aadcd484b8733e9382f69da1e/bd37b03aadcd484b8733e9382f69da1e.HD-1080p-7.2Mbps-63828889.mp4?v=0" target="_blank" style="color: var(--primary-color); text-decoration: none;">
                                    <i class="fas fa-video"></i> Watch
                                </a>
                            </td>
                            <td>SV216</td>
                            <td>Ruling the World</td>
                            <td>50</td>
                        </tr>
                        <tr>
                            <td><img src="https://klmfirework.com/cdn/shop/files/SV120.png?v=1764055048&width=1100" alt="SV120" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;"></td>
                            <td>
                                <a href="https://klmfirework.com/cdn/shop/videos/c/vp/036cdc26b03d43e485ae2b05f1f60256/036cdc26b03d43e485ae2b05f1f60256.HD-1080p-7.2Mbps-63753947.mp4?v=0" target="_blank" style="color: var(--primary-color); text-decoration: none;">
                                    <i class="fas fa-video"></i> Watch
                                </a>
                            </td>
                            <td>SV120</td>
                            <td>Long Teng (VIP)</td>
                            <td>50</td>
                        </tr>
                        <tr>
                            <td><img src="https://klmfirework.com/cdn/shop/files/SV102.png?v=1764052255&width=493" alt="SV102" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;"></td>
                            <td>
                                <a href="https://klmfirework.com/cdn/shop/videos/c/vp/3d4672874d1548fdb7e0ca80df461bf4/3d4672874d1548fdb7e0ca80df461bf4.HD-1080p-7.2Mbps-63659020.mp4?v=0" target="_blank" style="color: var(--primary-color); text-decoration: none;">
                                    <i class="fas fa-video"></i> Watch
                                </a>
                            </td>
                            <td>SV102</td>
                            <td>Three Killer Moves (3.0 Hole) (VIP)</td>
                            <td>50</td>
                        </tr>
                        <tr>
                            <td><img src="https://klmfirework.com/cdn/shop/files/SV116.png?v=1764054465&width=493" alt="SV116" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;"></td>
                            <td>
                                <a href="https://klmfirework.com/cdn/shop/videos/c/vp/d598d20f4e6e45fa9f0d340427938552/d598d20f4e6e45fa9f0d340427938552.HD-1080p-7.2Mbps-65253971.mp4?v=0" target="_blank" style="color: var(--primary-color); text-decoration: none;">
                                    <i class="fas fa-video"></i> Watch
                                </a>
                            </td>
                            <td>SV116</td>
                            <td>Ne Zha (VIP)</td>
                            <td>50</td>
                        </tr>
                        <tr>
                            <td><img src="https://klmfirework.com/cdn/shop/files/SV219.png?v=1764129727&width=493" alt="SV219" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;"></td>
                            <td>
                                <a href="https://klmfirework.com/cdn/shop/videos/c/vp/b625a6ed2c444dacbf7a6aafa0653376/b625a6ed2c444dacbf7a6aafa0653376.HD-1080p-7.2Mbps-63829389.mp4?v=0" target="_blank" style="color: var(--primary-color); text-decoration: none;">
                                    <i class="fas fa-video"></i> Watch
                                </a>
                            </td>
                            <td>SV219</td>
                            <td>King Long Teng Sheng Shi</td>
                            <td>70</td>
                        </tr>
                        <tr>
                            <td><img src="https://klmfirework.com/cdn/shop/files/SV118.png?v=1764054711&width=493" alt="SV118" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;"></td>
                            <td>
                                <a href="https://klmfirework.com/cdn/shop/videos/c/vp/5b6392f127b94f3e987e841fb4487cca/5b6392f127b94f3e987e841fb4487cca.HD-1080p-7.2Mbps-64935513.mp4?v=0" target="_blank" style="color: var(--primary-color); text-decoration: none;">
                                    <i class="fas fa-video"></i> Watch
                                </a>
                            </td>
                            <td>SV118</td>
                            <td>Meng Zhu King (VIP)</td>
                            <td>80</td>
                        </tr>
                        <tr>
                            <td><img src="https://klmfirework.com/cdn/shop/files/SV221.png?v=1764129930&width=493" alt="SV221" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;"></td>
                            <td>
                                <a href="https://klmfirework.com/cdn/shop/videos/c/vp/61ada7f1ec034373b205cfa7b61320c9/61ada7f1ec034373b205cfa7b61320c9.HD-1080p-7.2Mbps-64351944.mp4?v=0" target="_blank" style="color: var(--primary-color); text-decoration: none;">
                                    <i class="fas fa-video"></i> Watch
                                </a>
                            </td>
                            <td>SV221</td>
                            <td>Feng Yun</td>
                            <td>100</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: var(--border-radius);">
                <h4 style="color: var(--primary-color); margin-bottom: 1rem;"><i class="fas fa-info-circle"></i> Contest Rules</h4>
                <ul style="margin-left: 1.5rem; color: var(--gray-color);">
                    <li>Contest period: January 1 - March 31, 2026</li>
                    <li>Bonus cash awarded for each sale of contest products</li>
                </ul>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card total-orders">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="total-orders">0</div>
                            <div class="stat-label">Total Orders</div>
                        </div>
                        <div class="stat-icon total-orders">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card total-sales">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="total-sales">RM 0</div>
                            <div class="stat-label">Total Sales</div>
                        </div>
                        <div class="stat-icon total-sales">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card total-commission">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="total-commission">RM 0</div>
                            <div class="stat-label">Total Commission</div>
                        </div>
                        <div class="stat-icon total-commission">
                            <i class="fas fa-coins"></i>
                        </div>
                    </div>
                </div>
            </div>

<!-- Sales & Commission Chart -->
<div class="chart-container">
    <div class="chart-header">
        <h3 class="chart-title">My Sales & Commission Performance</h3>
    </div>
    <canvas id="salesCommissionChart"></canvas>
</div>

<!-- Orders Chart -->
<div class="chart-container">
    <div class="chart-header">
        <h3 class="chart-title">My Orders Performance</h3>
    </div>
    <canvas id="ordersChart"></canvas>
</div>
        </div>

        <!-- Customer Order Tab -->
        <div id="customer-order" class="tab-content">
            <div class="filters">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="order-search" placeholder="Search order data...">
                </div>

 <!-- ADD THIS DATE FILTER SECTION -->
    <div class="date-filter-container" style="display: flex; gap: 10px; align-items: center;">
        <div style="display: flex; align-items: center; gap: 5px;">
            <label style="font-weight: 600; color: var(--dark-color);">From:</label>
            <input type="date" id="date-from" class="filter-select" style="padding: 0.6rem;">
        </div>
        <div style="display: flex; align-items: center; gap: 5px;">
            <label style="font-weight: 600; color: var(--dark-color);">To:</label>
            <input type="date" id="date-to" class="filter-select" style="padding: 0.6rem;">
        </div>
        <button id="clear-date-filter" class="action-btn" style="padding: 0.6rem 1rem; background-color: #6c757d; color: white;">
            <i class="fas fa-times"></i> Clear
        </button>
    </div>
    <!-- END OF DATE FILTER SECTION -->

                <div>
                    <select class="filter-select" id="order-status-filter">
                        <option value="all">All Statuses</option>
                        <option value="paid">Paid</option>
                        <option value="pending">Pending</option>
                    </select>
                    <select class="filter-select" id="order-delivery-filter">
                        <option value="all">All Delivery</option>
                        <option value="delivered">Delivered</option>
                        <option value="pending">Pending</option>
                        <option value="Notice">Notice</option>
                        <option value="Packing">Packing</option>
                        <option value="On Delivery">On Delivery</option>
                        <option value="Complete">Complete</option>
                    </select>
                </div>
            </div>

            <div class="data-table-container">
                <div class="loading" id="orders-loading">
                    <div class="spinner"></div>
                    <p>Loading customer orders...</p>
                </div>
                <table class="data-table" id="orders-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Name</th>
                            <th>Contact</th>
                            <th>Address</th>
                            <th>Product</th>
                            <th>Qty</th>
                            <th>Postage</th>
                            <th>Note</th>
                            <th>Discount Code</th>
                            <th>Spin Prize</th>
                            <th>Total</th>
                            <th>Payment</th>
                            <th>Bill Code</th>
                            <th>Delivery</th> 
                            <th>Commission</th> 
                            <th>Remark</th>
                        </tr>
                    </thead>
                    <tbody id="orders-table-body">
                        <!-- Orders data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Top Agent Tab -->
        <div id="top-agent" class="tab-content">
            <div class="filters">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="agent-search" placeholder="Search agents...">
                </div>
            </div>

            <div class="data-table-container">
                <div class="loading" id="agents-loading">
                    <div class="spinner"></div>
                    <p>Loading agent rankings...</p>
                </div>
                <table class="data-table" id="agents-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Agent ID</th>
                            <th>Name</th>
                            <th>Total Sales (RM)</th>
                            <th>Total Commission (RM)</th>
                            <th>Type</th>
                        </tr>
                    </thead>
                    <tbody id="agents-table-body">
                        <!-- Agents data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

<!-- My Agent Tab -->
<div id="my-agent" class="tab-content">
    <div class="filters">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="my-agent-search" placeholder="Search my agents...">
        </div>
 <!-- ADD THIS DATE FILTER SECTION FOR MY AGENT TAB -->
        <div class="date-filter-container" style="display: flex; gap: 10px; align-items: center;">
            <div style="display: flex; align-items: center; gap: 5px;">
                <label style="font-weight: 600; color: var(--dark-color);">From:</label>
                <input type="date" id="my-agent-date-from" class="filter-select" style="padding: 0.6rem;">
            </div>
            <div style="display: flex; align-items: center; gap: 5px;">
                <label style="font-weight: 600; color: var(--dark-color);">To:</label>
                <input type="date" id="my-agent-date-to" class="filter-select" style="padding: 0.6rem;">
            </div>
            <button id="my-agent-clear-date-filter" class="action-btn" style="padding: 0.6rem 1rem; background-color: #6c757d; color: white;">
                <i class="fas fa-times"></i> Clear
            </button>
        </div>
        <!-- END OF DATE FILTER SECTION -->
    </div>

 <!-- ADD THIS REMINDER MESSAGE DIV HERE -->
    <div id="downline-reminder-message" class="downline-reminder-message" style="display: none;">
        <i class="fas fa-exclamation-triangle"></i>
        <div>
            <strong>Reminder:</strong> Your downline status is <span id="downline-status-text"></span>. 
            You cannot earn override commission yet. You need to have at least 1 successful order to be QUALIFIED as an upline agent.
        </div>
    </div>
    <!-- END OF REMINDER MESSAGE -->

    <div class="data-table-container">
        <div class="loading" id="my-agent-loading">
            <div class="spinner"></div>
            <p>Loading my agents...</p>
        </div>
        <table class="data-table" id="my-agent-table" style="display: none;">
            <thead>
                <tr>
                    <th>Agent Id</th>
                    <th>Total Orders</th>
                    <th>Override Commission</th>
                </tr>
            </thead>
            <tbody id="my-agent-table-body">
                <!-- My agents data will be populated here -->
            </tbody>
        </table>
    </div>
</div>

        <!-- Commission Rate Tab -->
        <div id="commission-rate" class="tab-content">
            <div class="filters">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="commission-search" placeholder="Search commission rates...">
                </div>
            </div>

            <div class="data-table-container">
                <div class="loading" id="commission-loading">
                    <div class="spinner"></div>
                    <p>Loading commission rates...</p>
                </div>
                <table class="data-table" id="commission-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Name</th>
                            <th>Size (Inch)</th>
                            <th>Basic</th>
                            <th>Premium (+50%)</th>
                        </tr>
                    </thead>
                    <tbody id="commission-table-body">
                        <!-- Commission rates data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- My Profile Tab -->
        <div id="my-profile" class="tab-content">
            <div class="loading" id="profile-loading">
                <div class="spinner"></div>
                <p>Loading profile information...</p>
            </div>
            
            <div id="profile-content" style="display: none;">
                <div class="profile-header" style="display: flex; align-items: center; gap: 20px; margin-bottom: 2rem;">
                    <div class="profile-avatar" style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); display: flex; align-items: center; justify-content: center; font-size: 2.5rem; color: white; font-weight: bold;">
                        <span id="profile-initials">A</span>
                    </div>
                    <div>
                        <h2 id="profile-name" style="margin-bottom: 0.5rem;"></h2>
                        <div id="profile-id" style="color: var(--gray-color); margin-bottom: 0.5rem;"></div>
                        <div id="profile-type" class="agent-type-badge basic" style="display: inline-block;"></div>

  <!-- UPGRADE MESSAGE (only for basic agents) -->
    <div id="upgrade-message" class="upgrade-message" style="display: none; margin-top: 1rem;">
        <i class="fas fa-crown"></i>
        <div>
            <strong>Upgrade to Premium!</strong>
            <p style="margin: 0.3rem 0 0 0; font-size: 0.9rem;">
                Get +50% commission rate on all your sales!
            </p>
            <p style="margin: 0.3rem 0 0 0; font-size: 0.9rem;">
                and +50% Higher Override Bonus earned from every downline order.
            </p>
        </div>
    </div>

                    </div>
                </div>

                <div class="profile-details" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                    <div class="profile-card" style="background: #f8f9fa; padding: 1.5rem; border-radius: var(--border-radius);">
                        <h3 style="margin-bottom: 1rem; color: var(--primary-color);">
                            <i class="fas fa-id-card"></i> Agent Information
                        </h3>
                        <div class="profile-field" style="margin-bottom: 0.8rem;">
                            <div style="font-weight: 600; color: var(--dark-color); margin-bottom: 0.2rem;">Agent ID</div>
                            <div id="profile-agent-id" style="color: var(--gray-color);"></div>
                        </div>
                        <div class="profile-field" style="margin-bottom: 0.8rem;">
                            <div style="font-weight: 600; color: var(--dark-color); margin-bottom: 0.2rem;">Name</div>
                            <div id="profile-full-name" style="color: var(--gray-color);"></div>
                        </div>
                        <div class="profile-field" style="margin-bottom: 0.8rem;">
                            <div style="font-weight: 600; color: var(--dark-color); margin-bottom: 0.2rem;">Type</div>
                            <div id="profile-agent-type" style="color: var(--gray-color);"></div>
                        </div>
    <!-- Add this new field -->
    <div class="profile-field" style="margin-bottom: 0.8rem;">
        <div style="font-weight: 600; color: var(--dark-color); margin-bottom: 0.2rem;">Downline Status</div>
        <div id="profile-downline-status" style="color: var(--gray-color);"></div>
 <!-- ADD THIS MESSAGE DIV -->
        <div id="downline-status-message" class="status-message" style="display: none; margin-top: 0.5rem; font-size: 0.85rem;"></div>
    </div>
                    </div>

                    <div class="profile-card" style="background: #f8f9fa; padding: 1.5rem; border-radius: var(--border-radius);">
                        <h3 style="margin-bottom: 1rem; color: var(--primary-color);">
                            <i class="fas fa-address-book"></i> Contact Information
                        </h3>
                        <div class="profile-field" style="margin-bottom: 0.8rem;">
                            <div style="font-weight: 600; color: var(--dark-color); margin-bottom: 0.2rem;">Phone</div>
                            <div id="profile-phone" style="color: var(--gray-color);"></div>
                        </div>
                        <div class="profile-field" style="margin-bottom: 0.8rem;">
                            <div style="font-weight: 600; color: var(--dark-color); margin-bottom: 0.2rem;">Email</div>
                            <div id="profile-email" style="color: var(--gray-color);"></div>
                        </div>
                        <div class="profile-field" style="margin-bottom: 0.8rem;">
                            <div style="font-weight: 600; color: var(--dark-color); margin-bottom: 0.2rem;">Address</div>
                            <div id="profile-address" style="color: var(--gray-color);"></div>
                        </div>
                    </div>

                    <div class="profile-card" style="background: #f8f9fa; padding: 1.5rem; border-radius: var(--border-radius);">
                        <h3 style="margin-bottom: 1rem; color: var(--primary-color);">
                            <i class="fas fa-university"></i> Bank Information
                        </h3>
                        <div class="profile-field" style="margin-bottom: 0.8rem;">
                            <div style="font-weight: 600; color: var(--dark-color); margin-bottom: 0.2rem;">Bank Name</div>
                            <div id="profile-bank-name" style="color: var(--gray-color);"></div>
                        </div>
                        <div class="profile-field" style="margin-bottom: 0.8rem;">
                            <div style="font-weight: 600; color: var(--dark-color); margin-bottom: 0.2rem;">Bank Account Number</div>
                            <div id="profile-bank-account" style="color: var(--gray-color);"></div>
                        </div>
                    </div>
                </div>
<!-- PERMANENT CONTACT MESSAGE (for both basic/premium) -->
<div class="contact-message">
    <i class="fas fa-phone-alt"></i>
    <div>
        <strong>Need to update your details or upgrade your plan?</strong>
        <p style="margin: 0.3rem 0 0 0; font-size: 0.9rem;">
            Please contact: +60198428621
        </p>
    </div>
</div>
            </div>
        </div>
    </div>

    <script>
        // ==================== LOGIN VERIFICATION ====================
        // Check if user is logged in
        const username = localStorage.getItem("username") || "";
        const userType = localStorage.getItem("userType") || "";
        const userId = localStorage.getItem("userId") || "";

        // Redirect to login if not logged in or not agent
        if (!username || userType.toLowerCase() !== "agent") {
            window.location.href = "index.html";
        }

        // Set welcome text
        document.addEventListener('DOMContentLoaded', function() {
            const welcomeElement = document.getElementById('welcomeText');
            if (welcomeElement && username) {
                welcomeElement.textContent = `Welcome ${username}!`;
            }
        });

        // Logout function
        function logout() {
            // Clear all stored login data
            localStorage.removeItem("username");
            localStorage.removeItem("userId");
            localStorage.removeItem("userType");
            
            // Redirect to login page
            window.location.href = "index.html";
        }
        // ==================== END LOGIN VERIFICATION ====================

        // URLs for Google Apps Script Web Apps
        const ORDER_DATABASE_URL = 'https://script.google.com/macros/s/AKfycbxhuHO7-6fGOIS-BF9kUYHIBNzPVspo3MTyRIZvZnRY0WzuYOavP_gPoG_OJyuTShPq/exec';
        const AGENT_DATABASE_URL = 'https://script.google.com/macros/s/AKfycbwL86AaXKMwV7FBIQMcXCTt9qlCHDvi2Ftqzr-u5ePJGdgzMqqVWFQwdbXMRET8cldY/exec';
        const SUPPLIER_DATABASE_URL = 'https://script.google.com/macros/s/AKfycbwYsRYtwcstQ1TbK0m8QyUBFmNydDQ2K-C8U1ANjZ4AZNySPsJI2el6QHFklWQ35Vb7/exec';

        // Global variables for data
        let ordersData = [];
        let agentsData = [];
        let suppliersData = [];
        let myAgentData = null;
        let salesChart = null;

        // Helper function to escape HTML special characters
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs and content
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab and corresponding content
                tab.classList.add('active');
                const tabId = tab.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
                
                // Load data for the tab when clicked
                if (tabId === 'dashboard') {
                    updateDashboardStats();
                    initializeSalesChart();
                } else if (tabId === 'customer-order') {
                    displayCustomerOrders();
                } else if (tabId === 'top-agent') {
                    displayTopAgents();
                } else if (tabId === 'my-agent') {
                    displayMyAgents();
                } else if (tabId === 'commission-rate') {
                    displayCommissionRates();
                } else if (tabId === 'my-profile') {
                    displayMyProfile();
                }
            });
        });

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            try {
               
                
                // Fetch all data in parallel
                const [ordersResult, agentsResult, suppliersResult] = await Promise.allSettled([
                    fetchOrdersData(),
                    fetchAgentsData(),
                    fetchSuppliersData()
                ]);
                
                // Handle orders data
                if (ordersResult.status === 'fulfilled') {
                    ordersData = ordersResult.value;
                   
                } else {
                   
                    showError(`Failed to load orders: ${ordersResult.reason.message || 'Unknown error'}`);
                }
                
                // Handle agents data
                if (agentsResult.status === 'fulfilled') {
                    agentsData = agentsResult.value;
                   
                    
                    // Find current agent's data
                    myAgentData = agentsData.find(agent => 
                        agent['Agent ID'] === userId || 
                        agent['Agent ID '] === userId || 
                        agent.agentId === userId
                    );
                    
                    if (myAgentData) {
                       
                    } else {
                   
                        showError('Agent profile not found. Please contact administrator.');
                    }
                } else {
               
                    showError(`Failed to load agents: ${agentsResult.reason.message || 'Unknown error'}`);
                }
                
                // Handle suppliers data
                if (suppliersResult.status === 'fulfilled') {
                    suppliersData = suppliersResult.value;
               
                } else {
              
                    showError(`Failed to load suppliers: ${suppliersResult.reason.message || 'Unknown error'}`);
                }
                
                // Update dashboard
                updateDashboardStats();
                
                // Display data for active tab
                if (document.getElementById('dashboard').classList.contains('active')) {
                    initializeSalesChart();
                } else if (document.getElementById('customer-order').classList.contains('active')) {
                    displayCustomerOrders();
                } else if (document.getElementById('top-agent').classList.contains('active')) {
                    displayTopAgents();
                } else if (document.getElementById('my-agent').classList.contains('active')) { 
                    displayMyAgents();                                                          
                } else if (document.getElementById('my-profile').classList.contains('active')) {
                    displayMyProfile();
                }
                
                // Set up search and filter functionality
                setupEventListeners();
                
            } catch (error) {
                console.error('Application error');
                showError('Failed to load dashboard. Please refresh the page.');
            }
        });

        // Show error message
        function showError(message) {
            const errorElement = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            errorText.textContent = message;
            errorElement.style.display = 'block';
            
            // Hide error after 10 seconds
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 10000);
        }

        // Function to fetch orders data
        async function fetchOrdersData() {
            try {
        
                const response = await fetch(ORDER_DATABASE_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const result = await response.json();
         
                
                if (result.success && Array.isArray(result.data)) {
                    // The first row is headers, so skip it
                    const headers = result.data[0];
                    const rows = result.data.slice(1);
                    
                    // Convert rows to objects with header keys
                    return rows.map(row => {
                        const obj = {};
                        headers.forEach((header, index) => {
                            obj[header] = row[index] || '';
                        });
                        return obj;
                    });
                } else {
                    throw new Error('Invalid data format');
                }
            } catch (error) {
                console.error('Data loading error occurred');
                throw error;
            }
        }

        // Function to fetch agents data
        async function fetchAgentsData() {
            try {

                const response = await fetch(AGENT_DATABASE_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const result = await response.json();
               
                
                if (result.success && Array.isArray(result.data)) {
                    // The first row is headers, so skip it
                    const headers = result.data[0];
                    const rows = result.data.slice(1);
                    
                    // Convert rows to objects with header keys
                    return rows.map(row => {
                        const obj = {};
                        headers.forEach((header, index) => {
                            // Fix: Trim header names to remove trailing spaces
                            const cleanHeader = header.trim();
                            obj[cleanHeader] = row[index] || '';
                        });
                        return obj;
                    });
                } else {
                    throw new Error('Invalid data format');
                }
            } catch (error) {
                console.error('Data loading error');
                throw error;
            }
        }

        // Function to fetch suppliers data
        async function fetchSuppliersData() {
            try {
             
                const response = await fetch(SUPPLIER_DATABASE_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const result = await response.json();
          
                
                if (result.success && Array.isArray(result.data)) {
                    return result.data;
                } else {
                    throw new Error('Invalid data format');
                }
            } catch (error) {
                console.error('Data loading error');
                throw error;
            }
        }

        // Update dashboard statistics
        function updateDashboardStats() {
            if (!myAgentData) return;
            
            // Filter orders for current agent
            const agentOrders = ordersData.filter(order => 
                order.UserId === userId || order.userId === userId
            );
            
            // Total Orders
            const totalOrders = agentOrders.length;
            document.getElementById('total-orders').textContent = totalOrders;
            
            // Total Sales
            let totalSales = 0;
            agentOrders.forEach(order => {
                const total = parseFloat(order.Total) || 0;
                totalSales += total;
            });
            document.getElementById('total-sales').textContent = `RM ${totalSales.toFixed(2)}`;
            
            // Total Commission
            let totalCommission = 0;
            agentOrders.forEach(order => {
                const commission = calculateCommission(order);
                totalCommission += commission;
            });
            document.getElementById('total-commission').textContent = `RM ${totalCommission.toFixed(2)}`;
        }

        // Calculate commission for an order
        function calculateCommission(order) {
            const productCode = order['Product Code'] || '';
            const productQuantity = parseInt(order['Product Quantity']) || 1;
            
            // Get commission rate from supplier database
            const commissionRate = getCommissionRate(productCode, suppliersData);
            
            // Apply agent type multiplier
            const agentMultiplier = getAgentCommissionMultiplier(myAgentData);
            
            // Calculate commission
            return (commissionRate * productQuantity) * agentMultiplier;
        }

        // Helper function to get commission rate for a product from supplier database
        function getCommissionRate(productCode, suppliersData) {
            if (!suppliersData || !productCode) return 0;
            
            // Find supplier by product code
            const supplier = suppliersData.find(s => s.Code === productCode);
            
            // Return Profit (Agent) or 0 if not found
            if (supplier && supplier['Profit (Agent)']) {
                return parseFloat(supplier['Profit (Agent)']) || 0;
            }
            
            return 0;
        }

        // Helper function to get agent commission multiplier based on type
        function getAgentCommissionMultiplier(agent) {
            if (!agent) return 0;
            
            const type = agent.Type || agent.type || 'basic';
            
            // Apply commission rules based on type
            if (type === 'premium') {
                return 1; // Full commission (100%)
            } else if (type === 'basic') {
                return 0.5; // 50% commission (-50% from original)
            }
            
            return 0; // Default fallback - no commission
        }

// Initialize sales & commission chart
function initializeSalesChart() {
    if (!myAgentData) return;
    
    // Filter orders for current agent
    const agentOrders = ordersData.filter(order => 
        order.UserId === userId || order.userId === userId
    );
    
    // Group sales and commission by month for last 6 months
    const salesByMonth = getSalesByMonth(agentOrders);
    const commissionByMonth = getCommissionByMonth(agentOrders);
    
    // Get last 6 months
    const months = getLast6Months();
    
    // Prepare data for chart
    const salesDataPoints = months.map(month => salesByMonth[month] || 0);
    const commissionDataPoints = months.map(month => commissionByMonth[month] || 0);
    
    // Format month labels
    const monthLabels = months.map(month => {
        const [year, monthNum] = month.split('-');
        const date = new Date(year, monthNum - 1);
        return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
    });
    
    // Destroy existing chart if it exists
    if (salesChart) {
        salesChart.destroy();
    }
    
    // Create line chart for Sales & Commission
    const salesCtx = document.getElementById('salesCommissionChart').getContext('2d');
    salesChart = new Chart(salesCtx, {
        type: 'line',
        data: {
            labels: monthLabels,
            datasets: [
                {
                    label: 'Sales (RM)',
                    data: salesDataPoints,
                    backgroundColor: 'rgba(114, 9, 183, 0.1)',
                    borderColor: '#7209b7',
                    borderWidth: 3,
                    tension: 0.2,
                    fill: true 
                },
                {
                    label: 'Commission (RM)',
                    data: commissionDataPoints,
                    backgroundColor: 'rgba(76, 201, 240, 0.1)',
                    borderColor: '#4cc9f0',
                    borderWidth: 3,
                    tension: 0.2,
                    fill: true 
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                },
                title: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        callback: function(value) {
                            return 'RM ' + value;
                        }
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            }
        }
    });
    
    // Initialize orders chart
    initializeOrdersChart(agentOrders, months, monthLabels);
} 

// Helper function to get commission by month
function getCommissionByMonth(orders) {
    const commissionByMonth = {};
    
    orders.forEach(order => {
        const date = new Date(order.Timestamp);
        const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        const commission = calculateCommission(order);
        
        if (!commissionByMonth[monthYear]) {
            commissionByMonth[monthYear] = 0;
        }
        commissionByMonth[monthYear] += commission;
    });
    
    return commissionByMonth;
}

// Initialize orders chart
function initializeOrdersChart(agentOrders, months, monthLabels) {
    // Group orders by month
    const ordersByMonth = getOrdersByMonth(agentOrders);
    
    // Prepare data for chart
    const ordersDataPoints = months.map(month => ordersByMonth[month] || 0);
    
    // Create bar chart for Orders
    const ordersCtx = document.getElementById('ordersChart').getContext('2d');
    const ordersChart = new Chart(ordersCtx, {
        type: 'bar',
        data: {
            labels: monthLabels,
            datasets: [{
                label: 'Number of Orders',
                data: ordersDataPoints,
                backgroundColor: '#ff6a00',
                borderColor: '#ff6a00',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                },
                title: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        callback: function(value) {
                            return value + ' orders';
                        }
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            }
        }
    });
}

// Helper function to get orders by month
function getOrdersByMonth(orders) {
    const ordersByMonth = {};
    
    orders.forEach(order => {
        const date = new Date(order.Timestamp);
        const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        
        if (!ordersByMonth[monthYear]) {
            ordersByMonth[monthYear] = 0;
        }
        ordersByMonth[monthYear] += 1;
    });
    
    return ordersByMonth;
}       

        // Helper function to get sales by month
        function getSalesByMonth(orders) {
            const salesByMonth = {};
            
            orders.forEach(order => {
                const date = new Date(order.Timestamp);
                const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                const total = parseFloat(order.Total) || 0;
                
                if (!salesByMonth[monthYear]) {
                    salesByMonth[monthYear] = 0;
                }
                salesByMonth[monthYear] += total;
            });
            
            return salesByMonth;
        }

        // Helper function to get last 6 months
        function getLast6Months() {
            const months = [];
            const now = new Date();
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                months.push(`${year}-${month}`);
            }
            
            return months;
        }

        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            
            try {
                const date = new Date(dateString);
                
                if (isNaN(date.getTime())) {
                    return dateString;
                }
                
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return dateString;
            }
        }

        // Display customer orders (only for current agent)
        function displayCustomerOrders() {
            const tableBody = document.getElementById('orders-table-body');
            const loadingElement = document.getElementById('orders-loading');
            const tableElement = document.getElementById('orders-table');
            
            // Clear existing rows
            tableBody.innerHTML = '';
            
            // Show loading, hide table
            loadingElement.style.display = 'flex';
            tableElement.style.display = 'none';
            
            // Check if we have data
            if (!ordersData || ordersData.length === 0 || !myAgentData) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="16" style="text-align: center; padding: 2rem;">
                            <i class="fas fa-exclamation-circle" style="font-size: 2rem; color: #6c757d; margin-bottom: 1rem;"></i>
                            <p>No orders data available.</p>
                        </td>
                    </tr>
                `;
                
                // Hide loading, show table
                loadingElement.style.display = 'none';
                tableElement.style.display = 'table';
                return;
            }
            
            // Filter orders for current agent
            const agentOrders = ordersData.filter(order => 
                order.UserId === userId || order.userId === userId
            );
            
            // Check if agent has any orders
            if (agentOrders.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="16" style="text-align: center; padding: 2rem;">
                            <i class="fas fa-shopping-cart" style="font-size: 2rem; color: #6c757d; margin-bottom: 1rem;"></i>
                            <p>You haven't made any sales yet.</p>
                        </td>
                    </tr>
                `;
                
                // Hide loading, show table
                loadingElement.style.display = 'none';
                tableElement.style.display = 'table';
                return;
            }
            
            // Populate table with orders data
            agentOrders.forEach(order => {
                const row = document.createElement('tr');
                
                // Determine payment status class
                const paymentStatus = order['Payment Status'] || 'pending';
                const paymentStatusClass = paymentStatus.toLowerCase() === 'paid' ? 'paid' : 'pending';
                
                // Determine delivery status class
                const deliveryStatus = order['Delivery Status'] || 'pending';
                const deliveryStatusClass = deliveryStatus.toLowerCase();
                let deliveryClass = 'pending';
                if (deliveryStatusClass === 'delivered' || deliveryStatusClass === 'complete') {
                    deliveryClass = 'delivered';
                } else if (deliveryStatusClass === 'cancelled') {
                    deliveryClass = 'cancelled';
                }
                
                // Escape special characters
                const timestamp = formatDate(order.Timestamp || 'N/A');
                const name = escapeHtml(order.Name || 'N/A');
                const phone = escapeHtml(order.Phone || 'N/A');
                const email = escapeHtml(order.Email || 'N/A');
                const contactInfo = `${phone}<br><small>${email}</small>`;
                const address = escapeHtml(order.Address || 'N/A');
                const productCode = escapeHtml(order['Product Code'] || '');
                const productName = escapeHtml(order['Product Name'] || 'N/A');
                const productInfo = `${productCode}<br><small>${productName}</small>`;
                const productQuantity = parseInt(order['Product Quantity']) || 1;
                const postageFee = parseFloat(order['Postage Fee'] || 0);
                const note = escapeHtml(order.Note || 'N/A');
                const discountCode = escapeHtml(order['Discount Code'] || 'N/A');
                const spinPrize = escapeHtml(order['Spin Prize'] || 'N/A');
                const total = parseFloat(order.Total || 0);
                const billCode = escapeHtml(order['Bill Code'] || 'N/A');
                const remark = escapeHtml(order.Remark || 'N/A'); // ADD THIS LINE
                
                // Calculate commission
                const commission = calculateCommission(order);
                
                row.innerHTML = `
    <td>${timestamp}</td>
    <td>${name}</td>
    <td>${contactInfo}</td>
    <td><div class="compact-text" title="${address}">${address}</div></td>
    <td>${productInfo}</td>
    <td>${productQuantity}</td>
    <td>RM ${postageFee.toFixed(2)}</td>
    <td><div class="compact-text" title="${note}">${note}</div></td>
    <td>${discountCode}</td>
    <td>${spinPrize}</td>
    <td>RM ${total.toFixed(2)}</td>
    <td><span class="status ${paymentStatusClass}">${paymentStatus}</span></td>
    <td>${billCode}</td>
    <td><span class="status ${deliveryClass}">${deliveryStatus}</span></td> 
    <td>RM ${commission.toFixed(2)}</td>
    <td><div class="compact-text" title="${remark}">${remark}</div></td>
`;
                
                tableBody.appendChild(row);
            });
            
            // Hide loading, show table
            loadingElement.style.display = 'none';
            tableElement.style.display = 'table';
        }

        // Display top agents ranking
        function displayTopAgents() {
            const tableBody = document.getElementById('agents-table-body');
            const loadingElement = document.getElementById('agents-loading');
            const tableElement = document.getElementById('agents-table');
            
            // Clear existing rows
            tableBody.innerHTML = '';
            
            // Show loading, hide table
            loadingElement.style.display = 'flex';
            tableElement.style.display = 'none';
            
            // Check if we have data
            if (!agentsData || agentsData.length === 0 || !ordersData || ordersData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem;">
                            <i class="fas fa-exclamation-circle" style="font-size: 2rem; color: #6c757d; margin-bottom: 1rem;"></i>
                            <p>No agent data available.</p>
                        </td>
                    </tr>
                `;
                
                // Hide loading, show table
                loadingElement.style.display = 'none';
                tableElement.style.display = 'table';
                return;
            }
            
            // Calculate sales and commission for each agent
            const agentStats = calculateAgentStats();
            
            // Sort agents by total sales (descending)
            const sortedAgents = Object.values(agentStats).sort((a, b) => b.totalSales - a.totalSales);
            
            // Populate table with agent rankings
            sortedAgents.forEach((agent, index) => {
                const row = document.createElement('tr');
                
                const rank = index + 1;
                const agentId = escapeHtml(agent.userId);
                const name = escapeHtml(agent.name || 'N/A');
                const totalSales = agent.totalSales;
                const totalCommission = agent.totalCommission;
                const type = agent.type || 'basic';
                const typeClass = type === 'premium' ? 'premium' : 'basic';
                
                // Highlight current agent's row
                const isCurrentAgent = agentId === userId;
                const rowStyle = isCurrentAgent ? 'background-color: rgba(67, 97, 238, 0.1); font-weight: 600;' : '';
                
                row.innerHTML = `
    <td style="${rowStyle}">
        ${rank === 1 ? ' ' : ''}
        ${rank === 2 ? ' ' : ''}
        ${rank === 3 ? ' ' : ''}
        ${rank > 3 ? rank : ''}
    </td>
    <td style="${rowStyle}">${agentId}</td>
    <td style="${rowStyle}">${name}</td>
    <td style="${rowStyle}">RM ${totalSales.toFixed(2)}</td>
    <td style="${rowStyle}">RM ${totalCommission.toFixed(2)}</td>
    <td style="${rowStyle}">
        <span class="agent-type-badge ${typeClass}">${type}</span>
    </td>
`;
                
                tableBody.appendChild(row);
            });
            
            // Hide loading, show table
            loadingElement.style.display = 'none';
            tableElement.style.display = 'table';
        }

        // Display commission rates from supplier database
        function displayCommissionRates() {
            const tableBody = document.getElementById('commission-table-body');
            const loadingElement = document.getElementById('commission-loading');
            const tableElement = document.getElementById('commission-table');
            
            // Clear existing rows
            tableBody.innerHTML = '';
            
            // Show loading, hide table
            loadingElement.style.display = 'flex';
            tableElement.style.display = 'none';
            
            // Check if we have supplier data
            if (!suppliersData || suppliersData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 2rem;">
                            <i class="fas fa-exclamation-circle" style="font-size: 2rem; color: #6c757d; margin-bottom: 1rem;"></i>
                            <p>No commission rate data available.</p>
                        </td>
                    </tr>
                `;
                
                // Hide loading, show table
                loadingElement.style.display = 'none';
                tableElement.style.display = 'table';
                return;
            }
            
            // Filter only the columns we need and calculate commissions
            const commissionData = suppliersData.map(supplier => {
                const profitAgent = parseFloat(supplier['Profit (Agent)']) || 0;
                return {
                    code: supplier.Code || '',
                    name: supplier.Name || '',
                    size: supplier.Inch || '',
                    basic: profitAgent / 2, // Basic = Profit (Agent) / 2
                    premium: profitAgent    // Premium = Profit (Agent)
                };
            });
            
            // Populate table with commission data
            commissionData.forEach(item => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${escapeHtml(item.code)}</td>
                    <td>${escapeHtml(item.name)}</td>
                    <td>${escapeHtml(item.size)}</td>
                    <td>RM ${item.basic.toFixed(2)}</td>
                    <td>RM ${item.premium.toFixed(2)}</td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Hide loading, show table
            loadingElement.style.display = 'none';
            tableElement.style.display = 'table';
            
            // Set up search for commission rates
            setupCommissionSearch();
        }

        // Set up search for commission rates
        function setupCommissionSearch() {
            const commissionSearch = document.getElementById('commission-search');
            if (commissionSearch) {
                commissionSearch.addEventListener('input', filterCommissionTable);
            }
        }
        
        // Filter commission table based on search
        function filterCommissionTable() {
            const searchTerm = document.getElementById('commission-search').value.toLowerCase();
            const rows = document.querySelectorAll('#commission-table-body tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length === 0) return;
                
                // Check ALL columns for search term
                let matchesSearch = !searchTerm;
                if (searchTerm) {
                    matchesSearch = false;
                    for (let i = 0; i < cells.length; i++) {
                        const cellText = cells[i].textContent.toLowerCase();
                        if (cellText.includes(searchTerm)) {
                            matchesSearch = true;
                            break;
                        }
                    }
                }
                
                if (matchesSearch) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Calculate agent statistics
        function calculateAgentStats() {
            const agentStats = {};
            
            // Initialize agent stats
            agentsData.forEach(agent => {
                const agentId = agent['Agent ID'] || agent['Agent ID '] || agent.agentId || '';
                const name = agent.Name || agent.name || '';
                const type = agent.Type || agent.type || 'basic';
                
                if (agentId) {
                    agentStats[agentId] = {
                        userId: agentId,
                        name: name,
                        type: type,
                        totalSales: 0,
                        totalCommission: 0
                    };
                }
            });
            
            // Calculate sales and commission for each order
            ordersData.forEach(order => {
                const orderUserId = order.UserId || order.userId || '';
                
                if (orderUserId && agentStats[orderUserId]) {
                    const total = parseFloat(order.Total) || 0;
                    agentStats[orderUserId].totalSales += total;
                    
                    // Find agent for commission calculation
                    const agent = agentsData.find(a => 
                        a['Agent ID'] === orderUserId || 
                        a['Agent ID '] === orderUserId || 
                        a.agentId === orderUserId
                    );
                    
                    if (agent) {
                        const commission = calculateCommissionForAgent(order, agent);
                        agentStats[orderUserId].totalCommission += commission;
                    }
                }
            });
            
            return agentStats;
        }

        // Calculate commission for a specific agent
        function calculateCommissionForAgent(order, agent) {
            const productCode = order['Product Code'] || '';
            const productQuantity = parseInt(order['Product Quantity']) || 1;
            
            // Get commission rate from supplier database
            const commissionRate = getCommissionRate(productCode, suppliersData);
            
            // Apply agent type multiplier
            const type = agent.Type || agent.type || 'basic';
            let agentMultiplier = 0.5; // basic = 50%
            if (type === 'premium') {
                agentMultiplier = 1; // premium = 100%
            }
            
            // Calculate commission
            return (commissionRate * productQuantity) * agentMultiplier;
        }

        // Display my profile information
        function displayMyProfile() {
            const loadingElement = document.getElementById('profile-loading');
            const profileContent = document.getElementById('profile-content');
            
            // Show loading, hide content
            loadingElement.style.display = 'flex';
            profileContent.style.display = 'none';
            
            // Check if we have agent data
            if (!myAgentData) {
                loadingElement.innerHTML = `
                    <div style="text-align: center;">
                        <i class="fas fa-exclamation-circle" style="font-size: 2rem; color: #6c757d; margin-bottom: 1rem;"></i>
                        <p>Profile not found. Please contact administrator.</p>
                    </div>
                `;
                return;
            }
            
            // Extract agent information
            const agentId = myAgentData['Agent ID'] || myAgentData['Agent ID '] || myAgentData.agentId || userId;
            const name = myAgentData.Name || myAgentData.name || 'N/A';
            const phone = myAgentData.Phone || myAgentData.phone || 'N/A';
            const email = myAgentData.Email || myAgentData['Email '] || myAgentData.email || 'N/A';
            const address = myAgentData.Address || myAgentData.address || 'N/A';
            const type = myAgentData.Type || myAgentData.type || 'basic';
            const bankName = myAgentData['Bank Name'] || myAgentData.bankName || 'N/A';
            const bankAccount = myAgentData['Bank Account Number'] || myAgentData.bankAccount || 'N/A';
            const downlineStatus = myAgentData['Downline Status'] || myAgentData.downlineStatus || 'unqualified';
            
            // Set profile initials
            const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
            document.getElementById('profile-initials').textContent = initials;
            
            // Set profile information
            document.getElementById('profile-name').textContent = name;
            document.getElementById('profile-id').textContent = `Agent ID: ${agentId}`;
            
            // Set agent type badge
            const typeElement = document.getElementById('profile-type');
            typeElement.textContent = type.toUpperCase();
            typeElement.className = `agent-type-badge ${type}`;

// Show upgrade message for basic agents
const upgradeMessage = document.getElementById('upgrade-message');
if (type.toLowerCase() === 'basic') {
    upgradeMessage.style.display = 'flex';
} else {
    upgradeMessage.style.display = 'none';
}
            
            // Set detailed information
            document.getElementById('profile-agent-id').textContent = agentId;
            document.getElementById('profile-full-name').textContent = name;
            document.getElementById('profile-agent-type').textContent = type.toUpperCase();
            // Set Downline Status with conditional message
const downlineStatusElement = document.getElementById('profile-downline-status');
const downlineMessageElement = document.getElementById('downline-status-message');
downlineStatusElement.textContent = downlineStatus.toUpperCase();

// Show message based on downline status
downlineMessageElement.style.display = 'none'; // Hide by default
downlineMessageElement.className = 'status-message'; // Reset classes

if (downlineStatus.toLowerCase() === 'unqualified') {
    downlineMessageElement.style.display = 'block';
    downlineMessageElement.classList.add('warning');
    downlineMessageElement.innerHTML = `
        <i class="fas fa-info-circle"></i> 
        You need to have at least <strong>one successful order</strong> to be QUALIFIED as an upline agent.
        Once qualified, you can recruit downline agents and earn override commissions from their sales.
    `;
} else if (downlineStatus.toLowerCase() === 'qualified') {
    downlineMessageElement.style.display = 'block';
    downlineMessageElement.classList.add('success');
    downlineMessageElement.innerHTML = `
        <i class="fas fa-check-circle"></i> 
        Congratulations! You are QUALIFIED to be an upline agent.
        You can now recruit downline agents and earn override commissions from their sales.
    `;
} else if (downlineStatus.toLowerCase() === 'pending') {
    downlineMessageElement.style.display = 'block';
    downlineMessageElement.classList.add('info');
    downlineMessageElement.innerHTML = `
        <i class="fas fa-clock"></i> 
        Your downline status is under review. Please contact administrator for more information.
    `;
}

document.getElementById('profile-phone').textContent = phone;
            document.getElementById('profile-email').textContent = email;
            document.getElementById('profile-address').textContent = address;
            document.getElementById('profile-bank-name').textContent = bankName;
            document.getElementById('profile-bank-account').textContent = bankAccount;
            
            // Hide loading, show content
            loadingElement.style.display = 'none';
            profileContent.style.display = 'block';
        }

        // Set up event listeners for search and filters
        function setupEventListeners() {
            // Order search
            const orderSearch = document.getElementById('order-search');
            if (orderSearch) {
                orderSearch.addEventListener('input', filterOrdersTable);
            }
            
            // Order status filter
            const orderStatusFilter = document.getElementById('order-status-filter');
            if (orderStatusFilter) {
                orderStatusFilter.addEventListener('change', filterOrdersTable);
            }
            
            // Order delivery filter
            const orderDeliveryFilter = document.getElementById('order-delivery-filter');
            if (orderDeliveryFilter) {
                orderDeliveryFilter.addEventListener('change', filterOrdersTable);
            }
            
            // Agent search
            const agentSearch = document.getElementById('agent-search');
            if (agentSearch) {
                agentSearch.addEventListener('input', filterAgentsTable);
            }
// Add this to setupEventListeners function for My Agent tab
// My Agent date from filter
const myAgentDateFrom = document.getElementById('my-agent-date-from');
if (myAgentDateFrom) {
    myAgentDateFrom.addEventListener('change', function() {
        filterMyAgentsByDate();
    });
}

// My Agent date to filter
const myAgentDateTo = document.getElementById('my-agent-date-to');
if (myAgentDateTo) {
    myAgentDateTo.addEventListener('change', function() {
        filterMyAgentsByDate();
    });
}

// My Agent clear date filter button
const myAgentClearDateFilter = document.getElementById('my-agent-clear-date-filter');
if (myAgentClearDateFilter) {
    myAgentClearDateFilter.addEventListener('click', function() {
        document.getElementById('my-agent-date-from').value = '';
        document.getElementById('my-agent-date-to').value = '';
        filterMyAgentsByDate();
    });
}

// Add this to setupEventListeners function
const myAgentSearch = document.getElementById('my-agent-search');
if (myAgentSearch) {
    myAgentSearch.addEventListener('input', filterMyAgentsTable);
}

// Commission search - ADD THIS
            const commissionSearch = document.getElementById('commission-search');
            if (commissionSearch) {
                commissionSearch.addEventListener('input', filterCommissionTable);
            }

// Date from filter
document.getElementById('date-from').addEventListener('change', function() {
    filterOrdersTable();
});

// Date to filter
document.getElementById('date-to').addEventListener('change', function() {
    filterOrdersTable();
});

// Clear date filter button
document.getElementById('clear-date-filter').addEventListener('click', function() {
    document.getElementById('date-from').value = '';
    document.getElementById('date-to').value = '';
    filterOrdersTable();
});
        }

// Filter orders table based on search and filters
function filterOrdersTable() {
    const searchTerm = document.getElementById('order-search').value.toLowerCase();
    const statusFilter = document.getElementById('order-status-filter').value;
    const deliveryFilter = document.getElementById('order-delivery-filter').value;
    // ADD THESE TWO LINES
    const dateFrom = document.getElementById('date-from').value;
    const dateTo = document.getElementById('date-to').value;
    
    const rows = document.querySelectorAll('#orders-table-body tr');
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length === 0) return;
        
        // Check ALL columns for search term
        let matchesSearch = !searchTerm;
        if (searchTerm) {
            matchesSearch = false;
            for (let i = 0; i < cells.length; i++) {
                const cellText = cells[i].textContent.toLowerCase();
                if (cellText.includes(searchTerm)) {
                    matchesSearch = true;
                    break;
                }
            }
        }
        
        // Get payment status (cell index 11)
        let paymentStatus = '';
        if (cells.length > 11) {
            const paymentElement = cells[11].querySelector('.status');
            paymentStatus = paymentElement ? paymentElement.textContent.trim().toLowerCase() : '';
        }
        
        // Check payment status match
        let matchesStatus = true;
        if (statusFilter !== 'all') {
            matchesStatus = paymentStatus === statusFilter.toLowerCase();
        }
        
        // Get delivery status (cell index 13)
        let deliveryStatus = '';
        if (cells.length > 13) {
            const deliveryElement = cells[13].querySelector('.status');
            deliveryStatus = deliveryElement ? deliveryElement.textContent.trim().toLowerCase() : '';
        }
        
        // Check delivery status match
        let matchesDelivery = true;
        if (deliveryFilter !== 'all') {
            matchesDelivery = deliveryStatus === deliveryFilter.toLowerCase();
        }
        
        // ADD DATE FILTERING CODE
        // Get timestamp from first cell
        const timestampText = cells[0].textContent;
        
        // Parse date from timestamp
        let orderDate = null;
        try {
            // Try to parse the date from the formatted timestamp
            const dateMatch = timestampText.match(/\w{3} \d{1,2}, \d{4}/);
            if (dateMatch) {
                orderDate = new Date(dateMatch[0]);
            } else {
                // Try parsing as ISO string
                orderDate = new Date(timestampText);
            }
        } catch (e) {
            orderDate = null;
        }
        
        // Check date range match
        let matchesDateRange = true;
        if (dateFrom || dateTo) {
            if (!orderDate) {
                matchesDateRange = false;
            } else {
                const fromDate = dateFrom ? new Date(dateFrom) : null;
                const toDate = dateTo ? new Date(dateTo) : null;
                
                if (fromDate) {
                    fromDate.setHours(0, 0, 0, 0);
                }
                if (toDate) {
                    toDate.setHours(23, 59, 59, 999);
                }
                
                const orderDateTime = orderDate.getTime();
                
                if (fromDate && toDate) {
                    matchesDateRange = orderDateTime >= fromDate.getTime() && 
                                      orderDateTime <= toDate.getTime();
                } else if (fromDate) {
                    matchesDateRange = orderDateTime >= fromDate.getTime();
                } else if (toDate) {
                    matchesDateRange = orderDateTime <= toDate.getTime();
                }
            }
        }
        
        // Show/hide row based on ALL filters (including date)
        if (matchesSearch && matchesStatus && matchesDelivery && matchesDateRange) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}    

        // Filter agents table based on search
        function filterAgentsTable() {
            const searchTerm = document.getElementById('agent-search').value.toLowerCase();
            const rows = document.querySelectorAll('#agents-table-body tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length === 0) return;
                
                // Check ALL columns for search term
                let matchesSearch = !searchTerm;
                if (searchTerm) {
                    matchesSearch = false;
                    for (let i = 0; i < cells.length; i++) {
                        const cellText = cells[i].textContent.toLowerCase();
                        if (cellText.includes(searchTerm)) {
                            matchesSearch = true;
                            break;
                        }
                    }
                }
                
                if (matchesSearch) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

// Update this function to fetch and display My Agents with date filtering
function displayMyAgents(dateFrom = null, dateTo = null) {
    const tableBody = document.getElementById('my-agent-table-body');
    const loadingElement = document.getElementById('my-agent-loading');
    const tableElement = document.getElementById('my-agent-table');

 // ADD THIS: Show/hide downline status reminder
    const reminderElement = document.getElementById('downline-reminder-message');
    const downlineStatusText = document.getElementById('downline-status-text');

 if (myAgentData) {
        const downlineStatus = myAgentData['Downline Status'] || myAgentData.downlineStatus || 'unqualified';
        
        if (downlineStatus.toLowerCase() === 'unqualified') {
            reminderElement.style.display = 'flex';
            downlineStatusText.textContent = 'UNQUALIFIED';
        } else if (downlineStatus.toLowerCase() === 'pending') {
            reminderElement.style.display = 'flex';
            downlineStatusText.textContent = 'PENDING';
        } else {
            reminderElement.style.display = 'none';
        }
    } else {
        reminderElement.style.display = 'none';
    }
    
    // Clear existing rows
    tableBody.innerHTML = '';
    
    // Show loading, hide table
    loadingElement.style.display = 'flex';
    tableElement.style.display = 'none';
    
    // Check if we have data
    if (!agentsData || agentsData.length === 0 || !ordersData || ordersData.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="3" style="text-align: center; padding: 2rem;">
                    <i class="fas fa-exclamation-circle" style="font-size: 2rem; color: #6c757d; margin-bottom: 1rem;"></i>
                    <p>No agent data available.</p>
                </td>
            </tr>
        `;
        
        // Hide loading, show table
        loadingElement.style.display = 'none';
        tableElement.style.display = 'table';
        return;
    }
    
    // Get current agent's downlines (agents where upline matches current agent ID)
    const myDownlines = agentsData.filter(agent => {
        const upline = agent.Upline || agent.upline || '';
        return upline === userId;
    });
    
    // Check if agent has any downlines
    if (myDownlines.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="3" style="text-align: center; padding: 2rem;">
                    <i class="fas fa-users" style="font-size: 2rem; color: #6c757d; margin-bottom: 1rem;"></i>
                    <p>You don't have any downline agents yet.</p>
                </td>
            </tr>
        `;
        
        // Hide loading, show table
        loadingElement.style.display = 'none';
        tableElement.style.display = 'table';
        return;
    }
    
    // Prepare date range for filtering
    let fromDate = null;
    let toDate = null;
    
    if (dateFrom) {
        fromDate = new Date(dateFrom);
        fromDate.setHours(0, 0, 0, 0);
    }
    
    if (dateTo) {
        toDate = new Date(dateTo);
        toDate.setHours(23, 59, 59, 999);
    }
    
    // Calculate statistics for each downline
    const downlineStats = myDownlines.map(downline => {
        const downlineId = downline['Agent ID'] || downline['Agent ID '] || downline.agentId || '';
        
        // Filter orders for this downline
const downlineOrders = ordersData.filter(order => {
    const orderDownline = order.Downline || order.downline || '';
    
    // FIRST: Check if the Downline column contains the CURRENT AGENT'S ID (upline)
    // This means the order is credited to the upline (izal1477shaf)
    if (orderDownline !== userId) {
        return false;
    }
    
    // SECOND: Check if the order was made by this downline agent
    // This means the order belongs to the downline (try6789tryt)
    const orderUserId = order.UserId || order.userId || '';
    if (orderUserId !== downlineId) {
        return false;
    }
            
            // Check date range if filters are applied
            if (fromDate || toDate) {
                try {
                    const orderDate = new Date(order.Timestamp);
                    
                    if (fromDate && toDate) {
                        return orderDate >= fromDate && orderDate <= toDate;
                    } else if (fromDate) {
                        return orderDate >= fromDate;
                    } else if (toDate) {
                        return orderDate <= toDate;
                    }
                } catch (e) {
                    // If date parsing fails, include the order
                    return true;
                }
            }
            
            return true;
        });
        
        // Now we have filtered orders that belong to this downline agent
        const totalOrders = downlineOrders.length;
        
        // Calculate override commission based on current agent's type
let overrideCommission = 0;
if (myAgentData && totalOrders > 0) {
    const myAgentType = myAgentData.Type || myAgentData.type || 'basic';
    const downlineStatus = myAgentData['Downline Status'] || myAgentData.downlineStatus || 'unqualified';
    
    // Only calculate commission if agent is qualified
    if (downlineStatus.toLowerCase() === 'qualified') {
        if (myAgentType.toLowerCase() === 'basic') {
            overrideCommission = totalOrders * 5; // RM5 per order for basic
        } else if (myAgentType.toLowerCase() === 'premium') {
            overrideCommission = totalOrders * 10; // RM10 per order for premium
        }
    }
    // If downlineStatus is 'unqualified' or 'pending', overrideCommission remains 0
}
        
        return {
            agentId: downlineId,
            totalOrders: totalOrders,
            overrideCommission: overrideCommission
        };
    });
    
    // Populate table with downline data
    downlineStats.forEach(stat => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
            <td>${escapeHtml(stat.agentId)}</td>
            <td>${stat.totalOrders}</td>
            <td>RM ${stat.overrideCommission.toFixed(2)}</td>
        `;
        
        tableBody.appendChild(row);
    });
    
    // Hide loading, show table
    loadingElement.style.display = 'none';
    tableElement.style.display = 'table';
}

// Add this function to filter My Agents table
function filterMyAgentsTable() {
    const searchTerm = document.getElementById('my-agent-search').value.toLowerCase();
    const rows = document.querySelectorAll('#my-agent-table-body tr');
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length === 0) return;
        
        // Check ALL columns for search term
        let matchesSearch = !searchTerm;
        if (searchTerm) {
            matchesSearch = false;
            for (let i = 0; i < cells.length; i++) {
                const cellText = cells[i].textContent.toLowerCase();
                if (cellText.includes(searchTerm)) {
                    matchesSearch = true;
                    break;
                }
            }
        }
        
        if (matchesSearch) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Add this function to handle My Agent date filtering
function filterMyAgentsByDate() {
    const dateFrom = document.getElementById('my-agent-date-from').value;
    const dateTo = document.getElementById('my-agent-date-to').value;
    
    // Call displayMyAgents with date filters
    displayMyAgents(dateFrom, dateTo);
}
    </script>
</body>
</html>
